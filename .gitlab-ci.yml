image: docker

services:
  - docker:dind

stages:
- ci
- deploy
#- clean

#clean:
#  stage: clean
#  script: docker-compose -f docker-compose.ci.yml down --remove-orphans

"Build and Quality":
  stage: ci
  script:
    - apk add --no-cache py-pip
    - pip install docker-compose
    - ./scripts/ci/build.sh
    #- ./scripts/ci/rubocop.sh
    - ./scripts/ci/test.sh
  artifacts:
    paths:
      - coverage/

production:
  stage: deploy
  image: ruby:2.3.3
  dependencies:
    - "Build and Quality"
  script:
    - echo "HEROKU_APP_NAME=$HEROKU_PRODUCTION_APP_NAME" >> .env
    - echo "HEROKU_API_KEY=$HEROKU_PRODUCTION_API_KEY" >> .env
    - export HEROKU_API_KEY=$HEROKU_PRODUCTION_API_KEY
    - export HEROKU_APP_NAME=$HEROKU_PRODUCTION_APP_NAME
    - ./scripts/ci/deploy.sh
  environment:
    name: production
    url: https://aeonvera.com
  only:
    - master

# https://about.gitlab.com/2016/11/03/publish-code-coverage-report-with-gitlab-pages/
pages:
  stage: deploy
  dependencies:
    - "Build and Quality"
  script:
    - mv coverage/ public/
  artifacts:
    paths:
      - public
    expire_in: 30 days
  only:
    - develop
