image: docker

services:
  - docker:dind

before_script:
  - apk add --no-cache py-pip
  - pip install docker-compose


stages:
- ci
- deploy
#- clean

#clean:
#  stage: clean
#  script: docker-compose -f docker-compose.ci.yml down --remove-orphans

"Build, Quality, and Deploy":
  stage: ci
  script:
    - ./scripts/ci/build.sh
    - ./scripts/ci/rubocop.sh
    - ./scripts/ci/test.sh
  artifacts:
    paths:
      - coverage/

# https://about.gitlab.com/2016/11/03/publish-code-coverage-report-with-gitlab-pages/
pages:
  stage: deploy
  dependencies:
    - "Build, Quality, and Deploy"
  script:
    - mv coverage/ public/
  artifacts:
    paths:
      - public
    expire_in: 30 days
  only:
    - develop
